clc
clear
%%
%%
%%

format long
nr = 1e-3 ;


%% SNR Problem
uintyRandomVectorEnergy = 2.497702391949678e+02;


%%
%%
bias_1 = [ 0.18304272  0.14565164  0.19617899  0.27907506  0.15864916  1.245542...
  1.1690245   1.364084    1.2032931   1.0160457   0.03768209  0.00392342...
  0.05123249  0.13055116 -0.04124544  0.35584834  0.11413573  0.42013517...
  0.12025961  0.15344502];
bias_1_nr = ChangeResolution(bias_1, nr);
bias_1_fx = fixed(bias_1_nr);

kernel_1 = [ 0.24563791 -0.14467856  0.10850843 -0.39787644 -0.5098749  -0.11353694...
   0.02218187 -0.0340073  -0.33570066  0.0763213   0.16829184 -0.16082548...
  -0.07099266 -0.37658748 -0.30645812 -0.23863754  0.01331254  0.04670782...
   0.21116936  0.2846079 ];
kernel_1_nr = ChangeResolution(kernel_1, nr);
kernel_1_fx = fixed(kernel_1_nr);

recurrent_1 = [[-0.3365406   0.02249622  0.10095938  0.04187063 -0.21479967 -0.01512604...
   0.12248006  0.06512003  0.02058101  0.11430716  0.53650576 -0.00096263...
   0.78393286  0.02005912 -0.4054979  -0.12934864  0.43255514  0.16171741...
  -0.43455687 -0.3624723 ];
 [ 0.02657479 -0.3709498  -0.21279027  0.6781377   0.39160845  0.22659329...
  -0.2985789  -0.1328486   0.3143769  -0.67940754  0.42782202  0.2557009...
  -0.2010569  -0.3346088  -0.0937928  -0.00920914  0.04868237 -0.17887112...
   0.00160935 -0.16597752];
 [ 0.43517867  0.19552872 -0.2506961  -0.15683934 -0.3865314   0.16287422...
   0.10400789 -0.4282152   0.13022563 -0.05869643 -0.02169153 -0.5799743...
   0.37169608  0.5163907   0.25600123  0.16048366  0.21304922 -0.48555595...
  -0.3313132  -0.05617174];
 [-0.06076015  0.6014397   0.3874644   0.2673392  -0.42797467  0.1489947...
   0.22600543  0.22614498  0.43652523 -0.17960712 -0.21364275 -0.2842715...
   0.25969923 -0.21605891  0.18286675  0.23453951 -0.05739561  0.6047121...
   0.04978022  0.19620651];
 [ 0.06637888  0.2836382  -0.09528367 -0.00207884  0.38936445  0.3249551...
  -0.22540879  0.10224499  0.36463007  0.2625798  -0.36024567 -0.44710177...
  -0.29070234  0.06621676 -0.09850025 -0.26587793  0.26114056  0.46116206...
   0.35590205  0.275201  ]];
recurrent_1_nr = ChangeResolution(recurrent_1, nr);
recurrent_1_fx = fixed(recurrent_1_nr);

%%
%%

bias_2 = [ 0.5168306   0.22399999  0.6418825   0.36712864  0.16733608  1.1306223...
  1.288887    1.2467422   1.3387111   1.2392708  -0.07994823 -0.05449295...
  0.05615281 -0.07677523  0.00213228  0.87978506  0.5734845   0.816683...
  0.5250953   0.53705317];
bias_2_nr = ChangeResolution(bias_2, nr);
bias_2_fx = fixed(bias_2_nr);

kernel_2 = [[ 0.3482026  -0.3351224   0.40674198  0.32725087  0.2604987   0.01208193...
   0.68394464 -0.02692164 -0.35291654 -0.31293964 -1.0233592   0.31069413...
   0.20118684 -0.51005864  0.5923462  -0.83130485  0.6026431  -0.0156643...
   0.24108557 -0.22499172];
 [-0.15207    -0.6461243  -0.38700858  0.24013914  0.49836162 -0.5221264...
  -0.21366161  0.0442473  -0.32573056  0.31190857 -0.79174316 -0.3253639...
   0.55082315  0.15011159 -0.12507807 -0.13108629 -1.1040689   0.07137541...
  -0.22416581  0.01397572];
 [ 0.3000136  -0.5653246   0.17057443 -0.04256605  0.07663316 -0.39873677...
   0.17653109 -0.07087447  0.2928572  -0.18811019 -0.24565814  0.40191457...
  -0.00938035 -0.05003897  0.690625   -0.5688222   0.23678285  0.5445574...
  -0.47583997 -0.64208007];
 [ 0.08723199  0.01372237  0.98590034  0.40758303 -0.02591458  0.26466987...
  -0.22262952  0.27336088  0.68788683  0.18434419  0.4928204  -0.22340408...
  -0.3978154  -0.11349613 -0.27987373  0.45933628  0.12272892  0.34957254...
  -0.09710133  1.1842127 ];
 [ 0.59895253 -0.34159485  0.23752767 -0.09039821 -0.35285473  0.1144288...
  -0.03589433  0.87136954 -0.11579722  0.781743    0.04533929 -0.42146415...
  -0.41118732  0.6024066   0.20308504  0.13406464 -0.04045317  0.6741235...
  -0.06869154  0.8051312 ]];
kernel_2_nr = ChangeResolution(kernel_2, nr);
kernel_2_fx = fixed(kernel_2_nr);

recurrent_2 = [[-0.04177354  0.25703707  0.06227964  0.39811143  0.23053914  0.12721664...
  -0.08112504 -0.49568015  0.09475993  0.04434731  0.08285066 -0.47707602...
  -0.9749972  -0.4160879  -0.20317408  0.4489547   0.0975136  -0.24563862...
   0.3720499   0.3461952 ];
 [-0.1401609   0.0398878  -0.6179839   0.02447981 -0.40252796 -0.6974872...
  -0.1490375  -0.04540185  0.07669619 -0.719721    0.03357396  0.43540758...
  -0.36461756  0.4794403   0.01168571 -1.1131905   0.35745847 -0.3265966...
  -0.34088272 -0.0547017 ];
 [ 0.53249884 -0.06979208  0.38382652  0.09962176  0.8055903   0.4531719...
  -0.1153428   0.29204997  0.14691393  0.38466817  0.42406738 -0.00548482...
  -0.2706051  -0.02396181  0.34239075  0.6970171   0.4241147   0.40627605...
  -0.07317879  0.57516056];
 [-0.8519118  -0.32918552 -0.35926095 -0.11760372 -0.13382713 -0.4595806...
  -0.8647501  -0.34683424 -0.01277557 -0.54684687  0.1841871   0.54396147...
  -0.19390205  0.20191534 -0.4341319  -0.2217488  -0.91951704 -1.0282359...
  -0.38444194 -0.33587325];
 [ 0.17352575 -0.13660118 -0.38954377  0.2116966  -0.00131609  0.21513334...
  -0.01273768  0.0816735  -0.3042907   0.24504402  0.03546997  0.25797993...
   0.44173172 -0.5044245   0.27705723 -0.59669596  0.4539732   0.38022688...
  -0.00885862 -0.07270877]];
recurrent_2_nr = ChangeResolution(recurrent_2, nr);
recurrent_2_fx = fixed(recurrent_2_nr);

%%
%%

bias_out = [ 0.08337606 -0.6788055  -0.16378093  0.7231125 ];
bias_out_nr = ChangeResolution(bias_out, nr);
bias_out_fx = fixed(bias_out_nr);

kernel_out = [[-0.6426893   1.1242067  -2.0560346   0.9821722 ];
 [ 2.7873054  -1.028075   -1.9244306  -0.6825234 ];
 [ 0.28963867 -2.0147026   0.5893123  -0.58166695];
 [-0.22636974 -1.0197822   0.12353355  2.9781752 ];
 [ 0.9537095   0.48478824  0.19275512 -2.1968389 ]];
kernel_out_nr = ChangeResolution(kernel_out, nr);
kernel_out_fx = fixed(kernel_out_nr);

%%
%%
%%

input_sequence_250_1 = [-0.999999999995053,-0.992882208425674,-0.971630944130562,-0.936548715144543,-0.888134910407983,-0.827078691056984,-0.754249180346111,-0.670683091848303,-0.577569972042112,-0.476235267355201,-0.368121456701313,-0.254767518085408,-0.137787021565424,-0.0188451604132870,0.100364952568478,0.218146386157295,0.332822546173860,0.442761041450501,0.546396920577181,0.642254948655225,0.728970606953738,0.805309516543177,0.870185009414662,0.922673596964184,0.962028115650970,0.987688362704634,0.999289070484144,0.996665105975476,0.979853821414399,0.949094522573924,0.904825062285471,0.847675607684457,0.778459669902399,0.698162523896228,0.607927183256255,0.509038129638578,0.402903028430331,0.291032690921314,0.175019568216660,0.0565150830251204,-0.0627938779997800,-0.181208976738932,-0.297044599094730,-0.408651849352973,-0.514442021864989,-0.612909215935449,-0.702651771997981,-0.782392223938971,-0.850995483552740,-0.907484998276190,-0.951056652201183,-0.981090212486779,-0.997158158234224,-0.999031766147703,-0.986684366352875,-0.960291722027511,-0.920229527440433,-0.867068060013764,-0.801564062535416,-0.724649971077054,-0.637420641955757,-0.541117766678640,-0.437112196720402,-0.326884429736841,-0.212003534989283,-0.0941048179718448,0.0251334578189089,0.144013960611379,0.260844451518084,0.373961873197673,0.481756023122698,0.582692474469444,0.675334418355658,0.758363116506764,0.830596673211246,0.891006859350498,0.938733749016731,0.973097960369933,0.993610326487972,0.999978858547489,0.992112902216255,0.970124428091820,0.934326437817381,0.885228508563588,0.823529539299848,0.750107802110300,0.666008440172178,0.572428590360148,0.470700342253154,0.362271776118940,0.248686349796399,0.131560927899135,0.0125627660898807,-0.106614221950203,-0.224273577022910,-0.338740443148511,-0.448385408783532,-0.551647701146088,-0.647057403482532,-0.733256379017479,-0.809017603739231,-0.873262632822641,-0.925076952058630,-0.963722995766160,-0.988650645879461,-0.999505062758379,-0.996131736251908,-0.978578685114310,-0.947095773465427,-0.902131154025503,-0.844324888754247,-0.774499837702943,-0.693649945775068,-0.602926094130718,-0.503619717637205,-0.397144421567848,-0.285015859231423,-0.168830156969773,-0.0502411936392874,0.0690629420022479,0.187383980879168,0.303037648096012,0.414377638231307,0.519819050143945,0.617860947702646,0.707107725291483,0.786288973957985,0.854277565413553,0.910105696464270,0.952978665483107,0.982286184818421,0.997611068108960,0.998735168843412,0.985642485630268,0.958519389975173,0.917751973323447,0.863920551131890,0.797791402203380,0.720305860872902,0.632566917315452,0.535823516717475,0.431452780809812,0.320940404834688,0.205859508991785,0.0878482454084484,-0.0314135206060174,-0.150228123084616,-0.266904261315815,-0.379781075149112,-0.487251786986072,-0.587786573918227,-0.679954344431820,-0.762443109692659,-0.834078659430175,-0.893841276573403,-0.940880252709625,-0.974525997741170,-0.994299571361878,-0.999919500674749,-0.991305786903247,-0.968581044161594,-0.932068754073801,-0.882288661086426,-0.819949374021816,-0.745938279186920,-0.661308908622428,-0.567265943302418,-0.465148064760619,-0.356408899246709,-0.242596325668457,-0.125330441866584,-0.00628050286783782,0.112858840604902,0.230391665125644,0.344644915675820,0.453992221228763,0.556877045798391,0.651834845401765,0.737513915535842,0.812694632409038,0.876306814032606,0.927444954040353,0.965381111386417,0.989575272438897,0.999683037966979,0.995560525598827,0.977266417964695,0.945061127370163,0.899403088890152,0.840942234650482,0.770510742189155,0.689111188592280,0.597902279027903,0.498182352828865,0.391370901912046,0.278988364615268,0.162634482582168,0.0439655287801953,-0.0753292691939972,-0.193551774912582,-0.309019115731140,-0.420087638127741,-0.525176304767341,-0.622789200239128,-0.711536825102467,-0.790155875124926,-0.857527224159195,-0.912691854676180,-0.954864509186476,-0.983444868224885,-0.998026095781600,-0.998400630537476,-0.984563140466217,-0.956710598745118,-0.915239479893619,-0.860740116051916,-0.793988293736553,-0.715934210691319,-0.627688950030134,-0.530508664209537,-0.425776693968481,-0.314983876768370,-0.199707325038585,-0.0815879763145012,0.0376927651628761,0.156436962883869,0.272954317841899,0.385586229588532,0.492729406067598,0.592858686147359,0.684548749976614,0.766494408122350,0.837529180677046,0.896641901865988,0.942991113791117,0.975917044419434,0.994950999311556,0.999822033400991,0.990460807852460,0.967000577097560,0.929775291997304,0.879314846132388,0.816337532889094,0.741739820712435,0.656583592073500,0.562081027801487,0.459577351948684,0.350531682811519,0.236496262689232,0.119094362040339];
input_sequence_250_2 = [-0.999999999995053,-0.991307234611204,-0.965380848812391,-0.922671565557573,-0.863921874152620,-0.790153122273424,-0.702647760108033,-0.602927045298722,-0.492724596277705,-0.373956253764822,-0.248686774377152,-0.119093935373600,0.0125693254361740,0.144014076430206,0.272955184656892,0.397151042279658,0.514442536349616,0.622790584427059,0.720311583504364,0.805310155960183,0.876308623264796,0.932072695043911,0.971632926902967,0.994301573973373,0.999684547185808,0.987688264413941,0.958521277383026,0.912690646059889,0.850993123554529,0.774501304781356,0.684544979681959,0.582688015178667,0.470701167760028,0.350531299344302,0.224267531595113,0.0941049270875828,-0.0376936712814507,-0.168836979227492,-0.297045104459300,-0.420089182013851,-0.535830122495371,-0.642255799590192,-0.737516030362303,-0.819954740206067,-0.888138753276813,-0.940882707884943,-0.977269663706051,-0.996667042555735,-0.998737625603000,-0.983445415838324,-0.951056263878899,-0.902133246231451,-0.837526876360243,-0.758360318738238,-0.666009862931160,-0.562080997167377,-0.448380497348290,-0.326885016724423,-0.199706722297450,-0.0690565753504303,0.0627941055355994,0.193553130761503,0.320947288827825,0.442761865524076,0.556879146158419,0.661315231476804,0.754254527236136,0.834081307839351,0.899407805306709,0.949098335263840,0.982289040522404,0.998402909016456,0.997159805011344,0.978581339195251,0.942990492988010,0.891006003598402,0.823531607444171,0.741740328935056,0.647054087754176,0.541118979159777,0.425776657052820,0.303032317308274,0.175019837971464,0.0439646823480517,-0.0878547900922218,-0.218146932398360,-0.344646649820727,-0.465154777891029,-0.577576314322154,-0.679956840076034,-0.770516496428896,-0.847680927351470,-0.910108649278898,-0.956714372453937,-0.986687868408152,-0.999508055574581,-0.994952058157338,-0.973099080771931,-0.934329031496636,-0.879315917272837,-0.809016126473492,-0.724651802344160,-0.627689596364987,-0.519815170900814,-0.402903894404186,-0.278988238627461,-0.150222444634905,-0.0188450718870238,0.112859918528688,0.242602869962555,0.368128235283581,0.487253788975556,0.597908564556146,0.698168857787052,0.786291669768711,0.860745008520146,0.920234522258817,0.963726001367998,0.990463357860661,0.999981769771811,0.992115761967180,0.967002082885734,0.925077327204461,0.867070345754790,0.793989574642305,0.707105503849617,0.607928590101209,0.498182997969279,0.379776625724616,0.254767937025220,0.125330175065145,-0.00628641868886115,-0.137793724355452,-0.266905522003016,-0.391377236983866,-0.509044961275916,-0.617863072456199,-0.715939796309996,-0.801570094829122,-0.873265307850008,-0.929779033019526,-0.970128794172048,-0.993613121418821,-0.999823746016631,-0.988652698011315,-0.960294183265365,-0.915241207238082,-0.854277004212943,-0.778461420972940,-0.689112491640037,-0.587783523995496,-0.476236095629358,-0.356409429374004,-0.230386680421866,-0.100358721217068,0.0314139462889564,0.162640488872274,0.291039567572116,0.414378998170970,0.530514557131918,0.637427258362238,0.733258452756383,0.816342140322113,0.885233933151774,0.938736165725240,0.975918716008370,0.996135175377700,0.999034086261541,0.984565052134054,0.952979613641662,0.904826875630707,0.840943961099331,0.762441458029227,0.670684112100312,0.567267100940529,0.453988302376777,0.332817038796247,0.205859840989295,0.0753238266606067,-0.0565216697363639,-0.187384548786332,-0.314989793661384,-0.437119020693342,-0.551649045392784,-0.656588793454627,-0.750113915062082,-0.830598500728354,-0.896643347304548,-0.947100282756556,-0.981092126831226,-0.998027940600772,-0.997613299776227,-0.979855413191084,-0.945062997471784,-0.893840910073854,-0.827079633987124,-0.745939796915719,-0.651831994062975,-0.546392265296930,-0.431453653019584,-0.309014335199005,-0.181202887563301,-0.0502412788641801,0.0815937574721021,0.212010303762722,0.338741102459700,0.459582971830627,0.572435107697153,0.675335605365655,0.766495566825743,0.844330200272017,0.907486371291886,0.954866126749412,0.985645782408578,0.999290242462762,0.995562302029141,0.974526770886750,0.936549346768128,0.882290257792217,0.812692784563254,0.728966861476107,0.632568042315120,0.525172195824297,0.408646371159681,0.285016339720694,0.156431377637203,0.0251269011598012,-0.106614395472730,-0.236502224080558,-0.362278518607781,-0.481756691013177,-0.592859644533403,-0.693655883467789,-0.782393091725726,-0.857528596382191,-0.917756186640588,-0.962028821962210,-0.989576834587501,-0.999921310003087,-0.992882412738736,-0.968582512752522,-0.927444058052947,-0.870182230541983,-0.797792512755489,-0.711533381650021,-0.612904430300245,-0.503620297855640,-0.385580860977554,-0.260838204970738,-0.131560948807967];
input_sequence_250_3 = [0.999999999995053,0.991307234611204,0.965380848812391,0.922671565557573,0.863921874152620,0.790153122273424,0.702647760108033,0.602927045298722,0.492724596277705,0.373956253764822,0.248686774377152,0.119093935373600,-0.0125693254361740,-0.144014076430206,-0.272955184656892,-0.397151042279658,-0.514442536349616,-0.622790584427059,-0.720311583504364,-0.805310155960183,-0.876308623264796,-0.932072695043911,-0.971632926902967,-0.994301573973373,-0.999684547185808,-0.987688264413941,-0.958521277383026,-0.912690646059889,-0.850993123554529,-0.774501304781356,-0.684544979681959,-0.582688015178667,-0.470701167760028,-0.350531299344302,-0.224267531595113,-0.0941049270875828,0.0376936712814507,0.168836979227492,0.297045104459300,0.420089182013851,0.535830122495371,0.642255799590192,0.737516030362303,0.819954740206067,0.888138753276813,0.940882707884943,0.977269663706051,0.996667042555735,0.998737625603000,0.983445415838324,0.951056263878899,0.902133246231451,0.837526876360243,0.758360318738238,0.666009862931160,0.562080997167377,0.448380497348290,0.326885016724423,0.199706722297450,0.0690565753504303,-0.0627941055355994,-0.193553130761503,-0.320947288827825,-0.442761865524076,-0.556879146158419,-0.661315231476804,-0.754254527236136,-0.834081307839351,-0.899407805306709,-0.949098335263840,-0.982289040522404,-0.998402909016456,-0.997159805011344,-0.978581339195251,-0.942990492988010,-0.891006003598402,-0.823531607444171,-0.741740328935056,-0.647054087754176,-0.541118979159777,-0.425776657052820,-0.303032317308274,-0.175019837971464,-0.0439646823480517,0.0878547900922218,0.218146932398360,0.344646649820727,0.465154777891029,0.577576314322154,0.679956840076034,0.770516496428896,0.847680927351470,0.910108649278898,0.956714372453937,0.986687868408152,0.999508055574581,0.994952058157338,0.973099080771931,0.934329031496636,0.879315917272837,0.809016126473492,0.724651802344160,0.627689596364987,0.519815170900814,0.402903894404186,0.278988238627461,0.150222444634905,0.0188450718870238,-0.112859918528688,-0.242602869962555,-0.368128235283581,-0.487253788975556,-0.597908564556146,-0.698168857787052,-0.786291669768711,-0.860745008520146,-0.920234522258817,-0.963726001367998,-0.990463357860661,-0.999981769771811,-0.992115761967180,-0.967002082885734,-0.925077327204461,-0.867070345754790,-0.793989574642305,-0.707105503849617,-0.607928590101209,-0.498182997969279,-0.379776625724616,-0.254767937025220,-0.125330175065145,0.00628641868886115,0.137793724355452,0.266905522003016,0.391377236983866,0.509044961275916,0.617863072456199,0.715939796309996,0.801570094829122,0.873265307850008,0.929779033019526,0.970128794172048,0.993613121418821,0.999823746016631,0.988652698011315,0.960294183265365,0.915241207238082,0.854277004212943,0.778461420972940,0.689112491640037,0.587783523995496,0.476236095629358,0.356409429374004,0.230386680421866,0.100358721217068,-0.0314139462889564,-0.162640488872274,-0.291039567572116,-0.414378998170970,-0.530514557131918,-0.637427258362238,-0.733258452756383,-0.816342140322113,-0.885233933151774,-0.938736165725240,-0.975918716008370,-0.996135175377700,-0.999034086261541,-0.984565052134054,-0.952979613641662,-0.904826875630707,-0.840943961099331,-0.762441458029227,-0.670684112100312,-0.567267100940529,-0.453988302376777,-0.332817038796247,-0.205859840989295,-0.0753238266606067,0.0565216697363639,0.187384548786332,0.314989793661384,0.437119020693342,0.551649045392784,0.656588793454627,0.750113915062082,0.830598500728354,0.896643347304548,0.947100282756556,0.981092126831226,0.998027940600772,0.997613299776227,0.979855413191084,0.945062997471784,0.893840910073854,0.827079633987124,0.745939796915719,0.651831994062975,0.546392265296930,0.431453653019584,0.309014335199005,0.181202887563301,0.0502412788641801,-0.0815937574721021,-0.212010303762722,-0.338741102459700,-0.459582971830627,-0.572435107697153,-0.675335605365655,-0.766495566825743,-0.844330200272017,-0.907486371291886,-0.954866126749412,-0.985645782408578,-0.999290242462762,-0.995562302029141,-0.974526770886750,-0.936549346768128,-0.882290257792217,-0.812692784563254,-0.728966861476107,-0.632568042315120,-0.525172195824297,-0.408646371159681,-0.285016339720694,-0.156431377637203,-0.0251269011598012,0.106614395472730,0.236502224080558,0.362278518607781,0.481756691013177,0.592859644533403,0.693655883467789,0.782393091725726,0.857528596382191,0.917756186640588,0.962028821962210,0.989576834587501,0.999921310003087,0.992882412738736,0.968582512752522,0.927444058052947,0.870182230541983,0.797792512755489,0.711533381650021,0.612904430300245,0.503620297855640,0.385580860977554,0.260838204970738,0.131560948807967];
input_sequence_250_4 = [0.999999999995053,0.992882208425674,0.971630944130562,0.936548715144543,0.888134910407983,0.827078691056984,0.754249180346111,0.670683091848303,0.577569972042112,0.476235267355201,0.368121456701313,0.254767518085408,0.137787021565424,0.0188451604132870,-0.100364952568478,-0.218146386157295,-0.332822546173860,-0.442761041450501,-0.546396920577181,-0.642254948655225,-0.728970606953738,-0.805309516543177,-0.870185009414662,-0.922673596964184,-0.962028115650970,-0.987688362704634,-0.999289070484144,-0.996665105975476,-0.979853821414399,-0.949094522573924,-0.904825062285471,-0.847675607684457,-0.778459669902399,-0.698162523896228,-0.607927183256255,-0.509038129638578,-0.402903028430331,-0.291032690921314,-0.175019568216660,-0.0565150830251204,0.0627938779997800,0.181208976738932,0.297044599094730,0.408651849352973,0.514442021864989,0.612909215935449,0.702651771997981,0.782392223938971,0.850995483552740,0.907484998276190,0.951056652201183,0.981090212486779,0.997158158234224,0.999031766147703,0.986684366352875,0.960291722027511,0.920229527440433,0.867068060013764,0.801564062535416,0.724649971077054,0.637420641955757,0.541117766678640,0.437112196720402,0.326884429736841,0.212003534989283,0.0941048179718448,-0.0251334578189089,-0.144013960611379,-0.260844451518084,-0.373961873197673,-0.481756023122698,-0.582692474469444,-0.675334418355658,-0.758363116506764,-0.830596673211246,-0.891006859350498,-0.938733749016731,-0.973097960369933,-0.993610326487972,-0.999978858547489,-0.992112902216255,-0.970124428091820,-0.934326437817381,-0.885228508563588,-0.823529539299848,-0.750107802110300,-0.666008440172178,-0.572428590360148,-0.470700342253154,-0.362271776118940,-0.248686349796399,-0.131560927899135,-0.0125627660898807,0.106614221950203,0.224273577022910,0.338740443148511,0.448385408783532,0.551647701146088,0.647057403482532,0.733256379017479,0.809017603739231,0.873262632822641,0.925076952058630,0.963722995766160,0.988650645879461,0.999505062758379,0.996131736251908,0.978578685114310,0.947095773465427,0.902131154025503,0.844324888754247,0.774499837702943,0.693649945775068,0.602926094130718,0.503619717637205,0.397144421567848,0.285015859231423,0.168830156969773,0.0502411936392874,-0.0690629420022479,-0.187383980879168,-0.303037648096012,-0.414377638231307,-0.519819050143945,-0.617860947702646,-0.707107725291483,-0.786288973957985,-0.854277565413553,-0.910105696464270,-0.952978665483107,-0.982286184818421,-0.997611068108960,-0.998735168843412,-0.985642485630268,-0.958519389975173,-0.917751973323447,-0.863920551131890,-0.797791402203380,-0.720305860872902,-0.632566917315452,-0.535823516717475,-0.431452780809812,-0.320940404834688,-0.205859508991785,-0.0878482454084484,0.0314135206060174,0.150228123084616,0.266904261315815,0.379781075149112,0.487251786986072,0.587786573918227,0.679954344431820,0.762443109692659,0.834078659430175,0.893841276573403,0.940880252709625,0.974525997741170,0.994299571361878,0.999919500674749,0.991305786903247,0.968581044161594,0.932068754073801,0.882288661086426,0.819949374021816,0.745938279186920,0.661308908622428,0.567265943302418,0.465148064760619,0.356408899246709,0.242596325668457,0.125330441866584,0.00628050286783782,-0.112858840604902,-0.230391665125644,-0.344644915675820,-0.453992221228763,-0.556877045798391,-0.651834845401765,-0.737513915535842,-0.812694632409038,-0.876306814032606,-0.927444954040353,-0.965381111386417,-0.989575272438897,-0.999683037966979,-0.995560525598827,-0.977266417964695,-0.945061127370163,-0.899403088890152,-0.840942234650482,-0.770510742189155,-0.689111188592280,-0.597902279027903,-0.498182352828865,-0.391370901912046,-0.278988364615268,-0.162634482582168,-0.0439655287801953,0.0753292691939972,0.193551774912582,0.309019115731140,0.420087638127741,0.525176304767341,0.622789200239128,0.711536825102467,0.790155875124926,0.857527224159195,0.912691854676180,0.954864509186476,0.983444868224885,0.998026095781600,0.998400630537476,0.984563140466217,0.956710598745118,0.915239479893619,0.860740116051916,0.793988293736553,0.715934210691319,0.627688950030134,0.530508664209537,0.425776693968481,0.314983876768370,0.199707325038585,0.0815879763145012,-0.0376927651628761,-0.156436962883869,-0.272954317841899,-0.385586229588532,-0.492729406067598,-0.592858686147359,-0.684548749976614,-0.766494408122350,-0.837529180677046,-0.896641901865988,-0.942991113791117,-0.975917044419434,-0.994950999311556,-0.999822033400991,-0.990460807852460,-0.967000577097560,-0.929775291997304,-0.879314846132388,-0.816337532889094,-0.741739820712435,-0.656583592073500,-0.562081027801487,-0.459577351948684,-0.350531682811519,-0.236496262689232,-0.119094362040339];

Tc = 1/(2e6);
t_samp = linspace(0, 1*Tc, 250);

C1_sigmoid = [0.250000000000000,0.248046875000000,0.244140625000000,0.238281250000000,0.231445312500000,0.222656250000000,0.212890625000000,0.202148437500000,0.190429687500000,0.178710937500000,0.166992187500000,0.155273437500000,0.143554687500000,0.131835937500000,0.121093750000000,0.110351562500000,0.100585937500000,0.0908203125000000,0.0820312500000000,0.0742187500000000,0.0664062500000000,0.0595703125000000,0.0537109375000000,0.0478515625000000,0.0429687500000000,0.0380859375000000,0.0341796875000000,0.0302734375000000,0.0263671875000000,0.0234375000000000,0.0214843750000000,0.0185546875000000,0.0166015625000000,0.0146484375000000,0.0126953125000000,0.0117187500000000,0.00976562500000000,0.00878906250000000,0.00781250000000000,0.00683593750000000,0.00585937500000000,0.00585937500000000,0.00488281250000000,0.00390625000000000,0.00390625000000000,0.00292968750000000,0.00292968750000000,0.00292968750000000,0.00195312500000000,0.00195312500000000,0.00195312500000000,0.00195312500000000,0.000976562500000000,0.000976562500000000,0.000976562500000000,0.000976562500000000,0.000976562500000000,0.000976562500000000,0.000976562500000000,0.000976562500000000,0.000976562500000000,0,0,0];
C2_sigmoid = [0.500000000000000,0.500000000000000,0.500976562500000,0.502929687500000,0.506835937500000,0.512695312500000,0.519531250000000,0.529296875000000,0.540039062500000,0.553710937500000,0.568359375000000,0.584960937500000,0.602539062500000,0.621093750000000,0.640625000000000,0.660156250000000,0.680664062500000,0.700195312500000,0.719726562500000,0.739257812500000,0.757812500000000,0.775390625000000,0.792968750000000,0.809570312500000,0.824218750000000,0.838867187500000,0.852539062500000,0.865234375000000,0.876953125000000,0.887695312500000,0.897460937500000,0.907226562500000,0.915039062500000,0.922851562500000,0.930664062500000,0.936523437500000,0.943359375000000,0.948242187500000,0.953125000000000,0.958007812500000,0.961914062500000,0.965820312500000,0.968750000000000,0.972656250000000,0.974609375000000,0.977539062500000,0.979492187500000,0.981445312500000,0.983398437500000,0.985351562500000,0.986328125000000,0.988281250000000,0.989257812500000,0.990234375000000,0.991210937500000,0.992187500000000,0.993164062500000,0.994140625000000,0.994140625000000,0.995117187500000,0.995117187500000,0.996093750000000,0.996093750000000,0.996093750000000];

C1_tanh = [0.995117187500000,0.964843750000000,0.907226562500000,0.830078125000000,0.740234375000000,0.644531250000000,0.549804687500000,0.461914062500000,0.381835937500000,0.311523437500000,0.251953125000000,0.202148437500000,0.161132812500000,0.127929687500000,0.101562500000000,0.0800781250000000,0.0625000000000000,0.0488281250000000,0.0380859375000000,0.0302734375000000,0.0234375000000000,0.0185546875000000,0.0146484375000000,0.0107421875000000,0.00878906250000000,0.00683593750000000,0.00488281250000000,0.00390625000000000,0.00292968750000000,0.00292968750000000,0.00195312500000000,0.00195312500000000,0.000976562500000000,0.000976562500000000,0.000976562500000000,0.000976562500000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
C2_tanh = [0,0.00390625000000000,0.0175781250000000,0.0468750000000000,0.0917968750000000,0.151367187500000,0.222656250000000,0.299804687500000,0.379882812500000,0.458007812500000,0.533203125000000,0.601562500000000,0.663085937500000,0.716796875000000,0.763671875000000,0.804687500000000,0.838867187500000,0.867187500000000,0.891601562500000,0.911132812500000,0.927734375000000,0.941406250000000,0.952148437500000,0.961914062500000,0.968750000000000,0.974609375000000,0.979492187500000,0.983398437500000,0.987304687500000,0.989257812500000,0.991210937500000,0.993164062500000,0.994140625000000,0.996093750000000,0.996093750000000,0.997070312500000,0.998046875000000,0.998046875000000,0.999023437500000,0.999023437500000,0.999023437500000,0.999023437500000,0.999023437500000,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];

%%
%%
%%
%%

NN_Signals_0dB = readmatrix("NN_Signals_2dB.xlsx");
NN_labels_0dB = readmatrix("NN_label_2dB.xlsx");

count = 0;
for s = 1:1:100
    h_1_old = zeros(1, 5);
    h_2_old = zeros(1, 5);

    c_1_old = zeros(1, 5);
    c_2_old = zeros(1, 5);

    c_1_new = zeros(1, 5);
    c_2_new = zeros(1, 5);

    h_1_new = zeros(1, 5);
    h_2_new = zeros(1, 5);
    for t = 1:1:250
        z_1 = fixed(fixed(ChangeResolution(NN_Signals_0dB(s, t), nr)) * kernel_1_fx);
        z_in = fixed(h_1_old * recurrent_1_fx);
        z_1 = fixed(z_1 + z_in);
        z_1 = fixed(z_1 + bias_1_fx);
        [z0, z1, z2, z3] = split(z_1);
        [c_1_new, o] = compute_carry_and_output_fused_x(double(z0), double(z1), double(z2), double(z3), c_1_old, C1_sigmoid, C2_sigmoid, C1_tanh, C2_tanh);
        h_1_new = fixed(OmultVec(o, fixed(TAnhVec(c_1_new, C1_tanh, C2_tanh))));

        z_2 = fixed(h_1_old * kernel_2_fx);
        z_2 = fixed(z_2 + (h_2_old * recurrent_2_fx));
        z_2 = fixed(z_2 + bias_2_fx);
        [z0, z1, z2, z3] = split(z_2);
        [c_2_new, o] = compute_carry_and_output_fused_x(double(z0), double(z1), double(z2), double(z3), c_2_old, C1_sigmoid, C2_sigmoid, C1_tanh, C2_tanh);    
        h_2_new = fixed(OmultVec(o, fixed(TAnhVec(c_2_new, C1_tanh, C2_tanh))));

        h_1_old = h_1_new;
        c_1_old = c_1_new;

        h_2_old = h_2_new;
        c_2_old = c_2_new;
    end
    out = Sigmoid(double(h_2_new * kernel_out_fx) + double(bias_out_fx));
    out_arg = argmax(out);
    
    if(out_arg ~= NN_labels_0dB(s, 1))
       count = count+1;
    end
end
count

figure
%%
%%
%%
%%

function [z0, z1, z2, z3] = split(z)
    z0 = z(1, 1:5);
    z1 = z(1, 6:10);
    z2 = z(1, 11:15);
    z3 = z(1, 16:20);
end

function [c, o] = compute_carry_and_output_fused(z0, z1, z2, z3, c_old)
    i = Sigmoid(z0);
    f = Sigmoid(z1);
    c = f .* c_old + i .* Tanh(z2);
    o = Sigmoid(z3);
end

function [c, o] = compute_carry_and_output_fused_x(z0, z1, z2, z3, c_old, C1_sigmoid, C2_sigmoid, C1_tanh, C2_tanh)
    i = fixed(SIGmoidVec(z0, C1_sigmoid, C2_sigmoid));
    f = fixed(SIGmoidVec(z1, C1_sigmoid, C2_sigmoid));
    c = fixed(OmultVec(f, c_old) + OmultVec(i, TAnhVec(z2, C1_tanh, C2_tanh)));
    o = fixed(SIGmoidVec(z3, C1_sigmoid, C2_sigmoid));
end




function vec = OmultVec(o, invec)
    vec = [(o(1, 1)*invec(1, 1)), (o(1, 2)*invec(1, 2)), (o(1, 3)*invec(1, 3)), (o(1, 4)*invec(1, 4)), (o(1, 5)*invec(1, 5))];
end

function vec = Tanh(invec)
    vec = [tanh(invec(1, 1)), tanh(invec(1, 2)), tanh(invec(1, 3)), tanh(invec(1, 4)), tanh(invec(1, 5))];
end

function y = Sigmoid(x)
    y = 1 ./ (1 + exp(-x));
end

function y = ChangeResolution(x, res)
    temp1 = x ./ res;
    temp2 = round(temp1);
    y = temp2 .* res;
end

function y = SIGmoid(x, C1, C2)
    if x>=0
       index = floor(x / (2^(-3))) + 1;
       res = C1(1, index)*x + C2(1, index);
    else
       index = floor(abs(x) / (2^(-3))) + 1;
       res = C1(1, index)*abs(x) + C2(1, index);
       res = 1 - res;
       
    end
    y = res;
end

function y = TAnh(x, C1, C2)
    if x>=0
       index = floor(x / (2^(-3))) + 1;
       res = C1(1, index)*x + C2(1, index);
    else
       index = floor(abs(x) / (2^(-3))) + 1;
       res = C1(1, index)*abs(x) + C2(1, index);
       res = 0 - res;
    end
    y = res;
end

function y = fixed(x)
    y = fi(x, 1, 14, 10);
end
function y = argmax(x)
    max_ind = 1;
    for i = 1:1:4
        if(x(1,i) > x(1, max_ind))
            max_ind = i;
        end
    end
   y = max_ind;
end

function vec = SIGmoidVec(invec, C1, C2)
    vec = [SIGmoid(invec(1, 1), C1, C2), SIGmoid(invec(1, 2), C1, C2), SIGmoid(invec(1, 3), C1, C2), SIGmoid(invec(1, 4), C1, C2), SIGmoid(invec(1, 5), C1, C2)];
end

function vec = SIGmoidVec4(invec, C1, C2)
    vec = [SIGmoid(invec(1, 1), C1, C2), SIGmoid(invec(1, 2), C1, C2), SIGmoid(invec(1, 3), C1, C2), SIGmoid(invec(1, 4), C1, C2)];
end

function vec = TAnhVec(invec, C1, C2)
    vec = [TAnh(invec(1, 1), C1, C2), TAnh(invec(1, 2), C1, C2), TAnh(invec(1, 3), C1, C2), TAnh(invec(1, 4), C1, C2), TAnh(invec(1, 5), C1, C2)];
end